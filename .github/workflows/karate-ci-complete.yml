name: Karate CI Tests (Completo)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 1ï¸âƒ£ PREPARACIÃ“N: Descargar cÃ³digo y configurar entorno
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“¥ Descargar repositorio
        uses: actions/checkout@v4

      - name: â˜• Configurar Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'  # â† Cachea dependencias Maven (mÃ¡s rÃ¡pido)

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 2ï¸âƒ£ SERVIDOR: Levantar la aplicaciÃ³n TODO en background
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸš€ Levantar servidor TODO
        run: |
          cd karate-todo-main
          echo "ğŸ”„ Iniciando servidor en background..."
          nohup mvn clean test -Dtest=LocalRunner > ../server.log 2>&1 &
          
          echo "â³ Esperando a que el servidor estÃ© listo..."
          for i in {1..30}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Servidor corriendo en http://localhost:8080"
              break
            fi
            echo "   Intento $i/30..."
            sleep 2
          done
          
          # Verificar que realmente estÃ¡ corriendo
          if ! curl -s http://localhost:8080 > /dev/null 2>&1; then
            echo "âŒ ERROR: El servidor no iniciÃ³ correctamente"
            echo "ğŸ“„ Logs del servidor:"
            cat ../server.log
            exit 1
          fi
          
          echo "ğŸ‰ Servidor listo para recibir pruebas"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 3ï¸âƒ£ PRUEBAS: Ejecutar tests de Karate
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ§ª Ejecutar pruebas Karate
        run: |
          cd karate-template-main
          echo "ğŸƒ Ejecutando suite de pruebas..."
          mvn clean test
        continue-on-error: true  # â† ContinÃºa aunque fallen tests

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 4ï¸âƒ£ DEBUG: Mostrar logs si algo falla
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“‹ Mostrar logs del servidor (si falla)
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ LOGS DEL SERVIDOR TODO:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat server.log
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ LOGS DE KARATE:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat karate-template-main/target/karate.log || echo "No hay logs de Karate"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 5ï¸âƒ£ REPORTES: Subir artefactos (HTML, JSON, XML)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“¦ Subir reportes HTML
        uses: actions/upload-artifact@v4
        if: always()  # â† Sube reportes incluso si fallan tests
        with:
          name: karate-html-reports
          path: karate-template-main/target/karate-reports/
          retention-days: 30  # â† Guardar 30 dÃ­as

      - name: ğŸ“Š Subir reportes JUnit XML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports
          path: karate-template-main/target/surefire-reports/
          retention-days: 30

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 6ï¸âƒ£ RESUMEN: Mostrar estadÃ­sticas en consola
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“ˆ Resumen de resultados
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESULTADOS DE EJECUCIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f "karate-template-main/target/surefire-reports/*.xml" ]; then
            echo "âœ… Reportes generados correctamente"
            echo ""
            echo "ğŸ“ UbicaciÃ³n de reportes:"
            echo "   - HTML: target/karate-reports/karate-summary.html"
            echo "   - XML:  target/surefire-reports/"
            echo ""
          else
            echo "âš ï¸  No se encontraron reportes XML"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸŒ GITHUB PAGES: Publicar reportes en la web
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  deploy-report:
    needs: test
    runs-on: ubuntu-latest
    if: always()  # â† Despliega incluso si fallan tests
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Descargar reportes generados
        uses: actions/download-artifact@v4
        with:
          name: karate-html-reports
          path: report-public/

      - name: ğŸ”§ Preparar index.html para GitHub Pages
        run: |
          cd report-public
          
          if [ -f "karate-summary.html" ]; then
            echo "âœ… Copiando karate-summary.html â†’ index.html"
            cp karate-summary.html index.html
          else
            echo "âŒ ERROR: karate-summary.html no encontrado"
            echo "ğŸ“‚ Contenido de report-public/:"
            ls -la
            exit 1
          fi

      - name: âš™ï¸  Configurar GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Subir artefactos a Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'report-public/'

      - name: ğŸš€ Desplegar en GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Reporte publicado
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Reporte disponible en:"
          echo "   ${{ steps.deployment.outputs.page_url }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
