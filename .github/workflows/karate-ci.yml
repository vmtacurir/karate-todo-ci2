name: Karate CI Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Descargar repositorio
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Java 21
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3ï¸âƒ£ Levantar el servidor TODO
      - name: ğŸš€ Start TODO Server
        run: |
          cd karate-todo-main
            echo "ğŸ“ Iniciando servidor TODO (LocalRunner)..."
            nohup mvn clean test -Dtest=LocalRunner > ../server.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Esperar a que el servidor estÃ© listo
          echo "â³ Esperando servidor (mÃ¡ximo 60 segundos)..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1 || curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Servidor estÃ¡ listo"
              sleep 2
              break
            fi
            echo "  Intento $i/30..."
            sleep 2
          done
          
          # Verificar una Ãºltima vez
          if ! curl -s http://localhost:8080 > /dev/null 2>&1; then
            echo "âŒ ERROR: Servidor no responde"
            echo "ğŸ“„ Server logs:"
            cat ../server.log
            exit 1
          fi
          echo "âœ… Servidor verificado y operativo"

      # 4ï¸âƒ£ Ejecutar pruebas Karate
      - name: ğŸ§ª Run Karate tests
        run: |
          cd karate-template-main
          echo "ğŸƒ Ejecutando suite de pruebas..."
          mvn clean test -Dtest=TC001Runner,TC002Runner,TC003Runner,TC004Runner,TC005Runner,TC011Runner -X 2>&1 | tee test-output.log
        continue-on-error: true

      # 4.5ï¸âƒ£ Mostrar output de pruebas
      - name: ğŸ“‹ Show test output
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ TEST OUTPUT:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cd karate-template-main
          cat test-output.log | tail -100
          echo ""
          echo "ğŸ“‚ Contenido de target:"
          ls -la target/ || echo "No target directory"
          echo ""
          echo "ğŸ“‚ Contenido de target/karate-reports:"
          ls -la target/karate-reports/ || echo "No karate-reports directory"

      # 5ï¸âƒ£ Mostrar logs en caso de error
      - name: ğŸ“‹ Show server logs on failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ SERVIDOR LOGS:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat server.log || echo "No server logs found"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # 6ï¸âƒ£ Subir reportes HTML
      - name: ğŸ“¦ Upload Karate HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: karate-html-reports
          path: karate-template-main/target/karate-reports/
          retention-days: 30
        continue-on-error: true

      # 7ï¸âƒ£ Subir reportes XML
      - name: ğŸ“Š Upload Surefire Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports
          path: karate-template-main/target/surefire-reports/
          retention-days: 30

  deploy-report:
    needs: test
    runs-on: ubuntu-latest
    if: needs.test.result == 'success'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ Download HTML Reports
        uses: actions/download-artifact@v4
        with:
          name: karate-html-reports
          path: report-public/
        continue-on-error: true

      - name: ğŸ“‚ Check artifacts
        run: |
          echo "ğŸ“‚ Contenido de report-public:"
          ls -la report-public/ || echo "No artifacts found"

      - name: ğŸ”§ Prepare index.html for GitHub Pages
        run: |
          cd report-public
          
          if [ -f "karate-summary.html" ]; then
            echo "âœ… karate-summary.html encontrado"
            cp karate-summary.html index.html
            echo "âœ… Copiado como index.html"
          else
            echo "âš ï¸  karate-summary.html no encontrado"
            echo "ğŸ“‚ Archivos disponibles:"
            ls -la
            
            # Si no hay reportes, crear uno vacÃ­o
            echo "<html><body><h1>No test reports available</h1><p>Los tests pueden haber fallado o no generaron reportes.</p></body></html>" > index.html
            echo "âš ï¸  Creado index.html placeholder"
          fi

      - name: âš™ï¸  Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ Upload Artifacts to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'report-public/'

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment Complete
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DESPLIEGUE COMPLETADO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "âš ï¸  Nota: Si no ves reportes, revisa que los tests ejecutaron correctamente"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
